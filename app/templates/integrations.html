{% extends "main.html" %}

{% block title %}Set Up Your Integrations{% endblock %}

{% block content %}
<div
  class="bg-white p-4 sm:p-8 rounded-xl shadow-lg 
         w-full max-w-full sm:max-w-lg
         mx-auto"
>
  <h1 class="text-2xl font-bold mb-6 break-words">Set Up Your Integrations</h1>

  <!-- Facebook Integration -->
  <div
    class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 mb-4 border border-gray-200 rounded-lg space-y-3 sm:space-y-0"
  >
    <div class="flex items-center space-x-4 min-w-0">
      <img
        src="/images/meta_ads_logo.png"
        alt="Meta Ads"
        class="w-6 h-6 flex-shrink-0"
      />
      <span class="font-medium text-gray-900 truncate">Meta Ads</span>
    </div>

    <!-- Connected / Disconnect -->
    <div
      id="facebook-connected"
      class="flex items-center space-x-4 hidden min-w-max"
    >
      <span
        class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800 whitespace-nowrap"
        >Active</span
      >
      <button
        id="facebook-disconnect-btn"
        class="bg-red-600 text-white text-sm font-semibold px-4 py-1 rounded hover:bg-red-700 transition whitespace-nowrap"
      >
        Disconnect
      </button>
    </div>

    <!-- Connect button -->
    <div
      id="facebook-connect"
      class="flex items-center min-w-max hidden"
    >
      <span
        class="inline-block px-3 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 mr-4 whitespace-nowrap"
        >Inactive</span
      >
      <a
        href="{{ url_for('integrations.facebook_connect') }}"
        class="bg-blue-700 text-white text-sm font-semibold px-4 py-1 rounded hover:bg-blue-800 transition whitespace-nowrap"
      >
        Connect
      </a>
    </div>
  </div>
  <div class="mt-4">
    <button
      onclick="syncToken()"
      id="sync-token-btn"
      class="bg-indigo-600 text-white text-sm font-semibold px-4 py-1 rounded hover:bg-indigo-700 transition whitespace-nowrap"
    >
      Sync Token
    </button>
    <span id="sync-status" class="ml-4 text-sm text-gray-600"></span>
  </div>
    <div id="facebook-continue-div" class="mt-4 hidden">
    <a
      href="https://claude.ai/settings/connectors"
      rel="noopener noreferrer"
      id="facebook-continue-btn"
      class="bg-green-600 text-white text-sm font-semibold px-4 py-1 rounded hover:bg-green-700 transition inline-block text-center"
    >
      Continue
    </a>
  </div>
</div>

<script>
  window.addEventListener("DOMContentLoaded", () => {
    const fbConnectDiv = document.getElementById("facebook-connect");
    const fbConnectedDiv = document.getElementById("facebook-connected");
    const disconnectBtn = document.getElementById("facebook-disconnect-btn");
    const fbContinueDiv = document.getElementById("facebook-continue-div");

    // Fetch the current Facebook token
    fetch("{{ url_for('integrations.api_facebook_token') }}", {
      method: "GET",
      credentials: "same-origin"
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.access_token) {
        // Show disconnect UI (connected)
        fbConnectedDiv.classList.remove("hidden");
        fbConnectDiv.classList.add("hidden");

        // Show Continue button
        fbContinueDiv.classList.remove("hidden");

        // Add event listener for Continue button
      } else {
        // Show connect UI (not connected)
        fbConnectDiv.classList.remove("hidden");
        fbConnectedDiv.classList.add("hidden");
        fbContinueDiv.classList.add("hidden");
      }
    })
    .catch(error => {
      console.error("Error fetching Facebook token:", error);
      // On error, fallback to connect UI
      fbConnectDiv.classList.remove("hidden");
      fbConnectedDiv.classList.add("hidden");
      fbContinueDiv.classList.add("hidden");
    });

    // Disconnect button handler
    disconnectBtn.addEventListener("click", async () => {
      const confirmDisconnect = confirm(
        "Are you sure you want to disconnect Facebook?"
      );
      if (!confirmDisconnect) return;

      try {
        const response = await fetch(
          "{{ url_for('integrations.facebook_disconnect') }}",
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "same-origin",
          }
        );

        if (response.ok) {
          alert("Facebook integration disconnected successfully.");
          fbConnectDiv.classList.remove("hidden");
          fbConnectedDiv.classList.add("hidden");
          fbContinueDiv.classList.add("hidden");

          localStorage.clear();
          document.cookie.split(";").forEach(cookie => {
            document.cookie = cookie
              .replace(/^ +/, "") // Trim spaces
              .replace(/=.*/, "=;expires=" + new Date(0).toUTCString() + ";path=/");
          });
        } else if (response.status === 404) {
          alert("No Facebook integration found to disconnect.");
        } else {
          alert("Failed to disconnect Facebook integration.");
        }
      } catch (error) {
        console.error("Error disconnecting Facebook:", error);
        alert("An error occurred. Please try again.");
      }
    });
  });

  async function syncToken() {
    const statusSpan = document.getElementById("sync-status");
    statusSpan.textContent = "Opening Claude.ai login window...";

    const loginWindow = window.open("https://claude.ai/login", "_blank", "width=600,height=700");

    if (!loginWindow) {
      statusSpan.textContent = "❌ Popup blocked. Please allow popups.";
      return;
    }

    let receivedOrgId = null;

    function messageHandler(event) {
      if (event.origin !== "https://claude.ai") return; // SECURITY: check origin
      if (event.data?.lastActiveOrg) {
        receivedOrgId = event.data.lastActiveOrg;
        window.removeEventListener("message", messageHandler);
        loginWindow.close();
        statusSpan.textContent = `Received organization ID: ${receivedOrgId}. Syncing...`;
        sendOrgIdToBackend(receivedOrgId);
      }
    }

    window.addEventListener("message", messageHandler);

    setTimeout(() => {
      if (!receivedOrgId) {
        window.removeEventListener("message", messageHandler);
        try { loginWindow.close(); } catch(e) {}
        statusSpan.textContent = "❌ No organization ID received automatically.";
        showManualOrgIdInput();
      }
    }, 30000);
  }

  function showManualOrgIdInput() {
    const container = document.createElement("div");
    container.innerHTML = `
      <label for="manualOrgId" class="block mt-4 font-medium text-gray-700">Please enter your organization ID from Claude.ai:</label>
      <input id="manualOrgId" type="text" class="border rounded px-2 py-1 mt-1 w-full max-w-xs" placeholder="Organization ID"/>
      <button id="submitOrgIdBtn" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded hover:bg-blue-700">Submit</button>
    `;
    document.querySelector("#sync-status").after(container);

    document.getElementById("submitOrgIdBtn").addEventListener("click", () => {
      const manualOrgId = document.getElementById("manualOrgId").value.trim();
      if (!manualOrgId) {
        alert("Please enter a valid organization ID.");
        return;
      }
      container.remove();
      document.getElementById("sync-status").textContent = `Syncing organization ID: ${manualOrgId}...`;
      sendOrgIdToBackend(manualOrgId);
    });
  }

  async function sendOrgIdToBackend(orgId) {
    const statusSpan = document.getElementById("sync-status");
    try {
      const res = await fetch("forward_token_to_10xer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ organization_id: orgId }),
        credentials: "same-origin",
      });
      const data = await res.json();
      if (res.ok) {
        statusSpan.textContent = "✅ Synced successfully.";
        statusSpan.classList.remove("text-red-600");
        statusSpan.classList.add("text-green-600");
      } else {
        statusSpan.textContent = `❌ ${data.error || "Sync failed."}`;
        statusSpan.classList.remove("text-green-600");
        statusSpan.classList.add("text-red-600");
      }
    } catch (error) {
      console.error("Sync error:", error);
      statusSpan.textContent = "❌ Unexpected error occurred.";
      statusSpan.classList.remove("text-green-600");
      statusSpan.classList.add("text-red-600");
    }
  }
</script>
{% endblock %}
